{% extends "base.html" %}

{% block title %}리포트 관리 - 관리자 패널{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-file-alt me-2"></i>리포트 관리
            </h2>
        </div>
    </div>

    <!-- 리포트 생성 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>새 리포트 생성
                    </h5>
                </div>
                <div class="card-body">
                    <form id="reportForm">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="reportType" class="form-label">리포트 유형</label>
                                    <select class="form-select" id="reportType" name="report_type" required>
                                        <option value="">선택하세요</option>
                                        <option value="daily">일일 리포트</option>
                                        <option value="weekly">주간 리포트</option>
                                        <option value="monthly">월간 리포트</option>
                                        <option value="custom">맞춤 리포트</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">시작일</label>
                                    <input type="date" class="form-control" id="startDate" name="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="endDate" class="form-label">종료일</label>
                                    <input type="date" class="form-control" id="endDate" name="end_date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus me-2"></i>리포트 생성
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 빠른 리포트 생성 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>빠른 리포트 생성
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="createQuickReport('daily')">
                                <i class="fas fa-calendar-day me-2"></i>오늘 리포트
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100 mb-2" onclick="createQuickReport('weekly')">
                                <i class="fas fa-calendar-week me-2"></i>이번 주 리포트
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-warning w-100 mb-2" onclick="createQuickReport('monthly')">
                                <i class="fas fa-calendar-alt me-2"></i>이번 달 리포트
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-danger w-100 mb-2" onclick="createQuickReport('quarterly')">
                                <i class="fas fa-chart-pie me-2"></i>분기별 리포트
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 기존 리포트 목록 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>생성된 리포트 목록 ({{ reports|length }}개)
                    </h5>
                </div>
                <div class="card-body">
                    {% if reports %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>리포트명</th>
                                    <th>유형</th>
                                    <th>기간</th>
                                    <th>생성일</th>
                                    <th>상태</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for report in reports %}
                                <tr>
                                    <td>{{ report.name }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if report.report_type == 'daily' else 'success' if report.report_type == 'weekly' else 'warning' if report.report_type == 'monthly' else 'info' }}">
                                            {{ report.report_type }}
                                        </span>
                                    </td>
                                    <td>
                                        {{ report.start_date.strftime('%Y-%m-%d') }} ~ {{ report.end_date.strftime('%Y-%m-%d') }}
                                    </td>
                                    <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <span class="badge bg-success">완료</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('download_report', report_id=report.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i> 다운로드
                                            </a>
                                            <button class="btn btn-sm btn-outline-info" onclick="viewReport({{ report.id }})">
                                                <i class="fas fa-eye"></i> 보기
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReport({{ report.id }})">
                                                <i class="fas fa-trash"></i> 삭제
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">생성된 리포트가 없습니다.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 리포트 통계 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                    <h5 class="card-title">총 리포트</h5>
                    <h3 class="text-primary">{{ reports|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-day fa-2x text-success mb-2"></i>
                    <h5 class="card-title">일일 리포트</h5>
                    <h3 class="text-success">{{ reports|selectattr('report_type', 'equalto', 'daily')|list|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-week fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">주간 리포트</h5>
                    <h3 class="text-warning">{{ reports|selectattr('report_type', 'equalto', 'weekly')|list|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-alt fa-2x text-info mb-2"></i>
                    <h5 class="card-title">월간 리포트</h5>
                    <h3 class="text-info">{{ reports|selectattr('report_type', 'equalto', 'monthly')|list|length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 리포트 템플릿 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-templates me-2"></i>리포트 템플릿
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-chart-line me-2"></i>성과 분석 리포트
                                    </h6>
                                    <p class="card-text">공연별 성과, 전환율, 사용자 행동 분석을 포함한 종합 리포트</p>
                                    <button class="btn btn-outline-primary btn-sm" onclick="createTemplateReport('performance')">
                                        생성하기
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body">
                                    <h6 class="card-title text-success">
                                        <i class="fas fa-users me-2"></i>관객 분석 리포트
                                    </h6>
                                    <p class="card-text">연령대, 성별, 지역별 관객 분석 및 선호도 조사 리포트</p>
                                    <button class="btn btn-outline-success btn-sm" onclick="createTemplateReport('audience')">
                                        생성하기
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h6 class="card-title text-warning">
                                        <i class="fas fa-chart-area me-2"></i>트렌드 분석 리포트
                                    </h6>
                                    <p class="card-text">시장 트렌드, 예측 모델, 핫 키워드 분석 리포트</p>
                                    <button class="btn btn-outline-warning btn-sm" onclick="createTemplateReport('trend')">
                                        생성하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 리포트 폼 제출
document.getElementById('reportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/admin/create-report', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('리포트가 성공적으로 생성되었습니다!');
            location.reload();
        } else {
            alert('오류: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('리포트 생성 중 오류가 발생했습니다.');
    });
});

// 빠른 리포트 생성
function createQuickReport(type) {
    const today = new Date();
    let startDate, endDate;
    
    switch(type) {
        case 'daily':
            startDate = today.toISOString().split('T')[0];
            endDate = today.toISOString().split('T')[0];
            break;
        case 'weekly':
            const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
            const weekEnd = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            startDate = weekStart.toISOString().split('T')[0];
            endDate = weekEnd.toISOString().split('T')[0];
            break;
        case 'monthly':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            startDate = monthStart.toISOString().split('T')[0];
            endDate = monthEnd.toISOString().split('T')[0];
            break;
        case 'quarterly':
            const quarter = Math.floor(today.getMonth() / 3);
            const quarterStart = new Date(today.getFullYear(), quarter * 3, 1);
            const quarterEnd = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
            startDate = quarterStart.toISOString().split('T')[0];
            endDate = quarterEnd.toISOString().split('T')[0];
            break;
    }
    
    const formData = new FormData();
    formData.append('report_type', type);
    formData.append('start_date', startDate);
    formData.append('end_date', endDate);
    
    fetch('/admin/create-report', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${type} 리포트가 성공적으로 생성되었습니다!`);
            location.reload();
        } else {
            alert('오류: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('리포트 생성 중 오류가 발생했습니다.');
    });
}

// 템플릿 리포트 생성
function createTemplateReport(template) {
    alert(`${template} 템플릿 리포트 생성 기능이 곧 추가됩니다.`);
}

// 리포트 보기
function viewReport(reportId) {
    alert(`리포트 ID: ${reportId} 상세 보기 기능이 곧 추가됩니다.`);
}

// 리포트 삭제
function deleteReport(reportId) {
    if (confirm('정말로 이 리포트를 삭제하시겠습니까?')) {
        alert(`리포트 ID: ${reportId} 삭제 기능이 곧 추가됩니다.`);
    }
}
</script>
{% endblock %} 