{% extends "base.html" %}

{% set lang = g.lang if g.lang else 'ko' %}

{% block title %}
    {% if lang == 'en' %}Submit - KOPIS Performing Arts Platform{% elif lang == 'ja' %}申請 - KOPIS公演プラットフォーム{% elif lang == 'zh' %}申请 - KOPIS演出宣传平台{% else %}공연 신청 - KOPIS 공연 홍보 플랫폼{% endif %}
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-plus me-2"></i>
                        {% if lang == 'en' %}Submit Performance/Competition{% elif lang == 'ja' %}公演/大会申請{% elif lang == 'zh' %}申请演出/大赛{% else %}공연 신청{% endif %}
                    </h3>
                </div>
                <div class="card-body p-4">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="/submit" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="title" class="form-label">
                                    <i class="fas fa-music me-1"></i>
                                    {% if lang == 'en' %}Title *{% elif lang == 'ja' %}タイトル *{% elif lang == 'zh' %}标题 *{% else %}공연 제목 *{% endif %}
                                </label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="group_name" class="form-label">
                                    <i class="fas fa-users me-1"></i>
                                    {% if lang == 'en' %}Team/Crew Name *{% elif lang == 'ja' %}チーム/クルー名 *{% elif lang == 'zh' %}团队/组合名 *{% else %}팀/크루명 *{% endif %}
                                </label>
                                <input type="text" class="form-control" id="group_name" name="group_name" required>
                            </div>
                        </div>

                        <!-- 카테고리 선택 -->
                        <div class="mb-3">
                            <label for="main_category" class="form-label">
                                <i class="fas fa-list me-1"></i>
                                {% if lang == 'en' %}Main Category *{% elif lang == 'ja' %}メインカテゴリ *{% elif lang == 'zh' %}主类别 *{% else %}메인 카테고리 *{% endif %}
                            </label>
                            <select class="form-select" id="main_category" name="main_category" required onchange="updateSubCategories()">
                                <option value="">{% if lang == 'en' %}Select main category{% elif lang == 'ja' %}メインカテゴリを選択{% elif lang == 'zh' %}请选择主类别{% else %}메인 카테고리를 선택하세요{% endif %}</option>
                                <option value="공연">{% if lang == 'en' %}Performance{% elif lang == 'ja' %}公演{% elif lang == 'zh' %}演出{% else %}공연{% endif %}</option>
                                <option value="대회">{% if lang == 'en' %}Competition{% elif lang == 'ja' %}大会{% elif lang == 'zh' %}大赛{% else %}대회{% endif %}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">
                                <i class="fas fa-tags me-1"></i>
                                {% if lang == 'en' %}Subcategory *{% elif lang == 'ja' %}サブカテゴリ *{% elif lang == 'zh' %}子类别 *{% else %}세부 카테고리 *{% endif %}
                            </label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">{% if lang == 'en' %}Select subcategory after main category{% elif lang == 'ja' %}メインカテゴリを先に選択{% elif lang == 'zh' %}请先选择主类别{% else %}먼저 메인 카테고리를 선택하세요{% endif %}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>
                                {% if lang == 'en' %}Description *{% elif lang == 'ja' %}紹介 *{% elif lang == 'zh' %}介绍 *{% else %}공연 소개 *{% endif %}
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="4" 
                                      placeholder="{% if lang == 'en' %}Describe the features, composition, dance style, etc.{% elif lang == 'ja' %}特徴、構成、ダンススタイルなどを詳しく説明してください{% elif lang == 'zh' %}请详细描述演出的特点、构成、舞蹈风格等{% else %}공연의 특징, 구성, 댄스 스타일 등을 자세히 설명해주세요{% endif %}" required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="location" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {% if lang == 'en' %}Region *{% elif lang == 'ja' %}地域 *{% elif lang == 'zh' %}地区 *{% else %}지역 *{% endif %}
                                </label>
                                <select class="form-select" id="location" name="location" required>
                                    <option value="">{% if lang == 'en' %}Select region{% elif lang == 'ja' %}地域を選択{% elif lang == 'zh' %}请选择地区{% else %}지역을 선택하세요{% endif %}</option>
                                    <option value="서울특별시">{% if lang == 'en' %}Seoul{% elif lang == 'ja' %}ソウル特別市{% elif lang == 'zh' %}首尔特别市{% else %}서울특별시{% endif %}</option>
                                    <option value="경기도">{% if lang == 'en' %}Gyeonggi-do{% elif lang == 'ja' %}京畿道{% elif lang == 'zh' %}京畿道{% else %}경기도{% endif %}</option>
                                    <option value="강원도">{% if lang == 'en' %}Gangwon-do{% elif lang == 'ja' %}江原道{% elif lang == 'zh' %}江原道{% else %}강원도{% endif %}</option>
                                    <option value="인천광역시">{% if lang == 'en' %}Incheon{% elif lang == 'ja' %}仁川広域市{% elif lang == 'zh' %}仁川广域市{% else %}인천광역시{% endif %}</option>
                                    <option value="충청남도">{% if lang == 'en' %}Chungcheongnam-do{% elif lang == 'ja' %}忠清南道{% elif lang == 'zh' %}忠清南道{% else %}충청남도{% endif %}</option>
                                    <option value="충청북도">{% if lang == 'en' %}Chungcheongbuk-do{% elif lang == 'ja' %}忠清北道{% elif lang == 'zh' %}忠清北道{% else %}충청북도{% endif %}</option>
                                    <option value="세종특별자치시">{% if lang == 'en' %}Sejong{% elif lang == 'ja' %}世宗特別自治市{% elif lang == 'zh' %}世宗特别自治市{% else %}세종특별자치시{% endif %}</option>
                                    <option value="대전광역시">{% if lang == 'en' %}Daejeon{% elif lang == 'ja' %}大田広域市{% elif lang == 'zh' %}大田广域市{% else %}대전광역시{% endif %}</option>
                                    <option value="경상북도">{% if lang == 'en' %}Gyeongsangbuk-do{% elif lang == 'ja' %}慶尚北道{% elif lang == 'zh' %}庆尚北道{% else %}경상북도{% endif %}</option>
                                    <option value="대구광역시">{% if lang == 'en' %}Daegu{% elif lang == 'ja' %}大邱広域市{% elif lang == 'zh' %}大邱广域市{% else %}대구광역시{% endif %}</option>
                                    <option value="전라북도">{% if lang == 'en' %}Jeollabuk-do{% elif lang == 'ja' %}全羅北道{% elif lang == 'zh' %}全罗北道{% else %}전라북도{% endif %}</option>
                                    <option value="경상남도">{% if lang == 'en' %}Gyeongsangnam-do{% elif lang == 'ja' %}慶尚南道{% elif lang == 'zh' %}庆尚南道{% else %}경상남도{% endif %}</option>
                                    <option value="울산광역시">{% if lang == 'en' %}Ulsan{% elif lang == 'ja' %}蔚山広域市{% elif lang == 'zh' %}蔚山广域市{% else %}울산광역시{% endif %}</option>
                                    <option value="부산광역시">{% if lang == 'en' %}Busan{% elif lang == 'ja' %}釜山広域市{% elif lang == 'zh' %}釜山广域市{% else %}부산광역시{% endif %}</option>
                                    <option value="광주광역시">{% if lang == 'en' %}Gwangju{% elif lang == 'ja' %}光州広域市{% elif lang == 'zh' %}光州广域市{% else %}광주광역시{% endif %}</option>
                                    <option value="전라남도">{% if lang == 'en' %}Jeollanam-do{% elif lang == 'ja' %}全羅南道{% elif lang == 'zh' %}全罗南道{% else %}전라남도{% endif %}</option>
                                    <option value="제주도">{% if lang == 'en' %}Jeju-do{% elif lang == 'ja' %}済州道{% elif lang == 'zh' %}济州道{% else %}제주도{% endif %}</option>
                                </select>
                                <small class="form-text text-muted">{% if lang == 'en' %}Region is set automatically when you enter the address.{% elif lang == 'ja' %}住所を入力すると自動で地域が設定されます。{% elif lang == 'zh' %}输入地址时会自动设置地区。{% else %}주소를 입력하면 자동으로 지역이 설정됩니다.{% endif %}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="price" class="form-label">
                                    <i class="fas fa-won-sign me-1"></i>
                                    {% if lang == 'en' %}Ticket Price *{% elif lang == 'ja' %}チケット価格 *{% elif lang == 'zh' %}票价 *{% else %}티켓 가격 *{% endif %}
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">₩</span>
                                    <input type="text" class="form-control" id="price" name="price" 
                                           placeholder="{% if lang == 'en' %}e.g. 1,000,000{% elif lang == 'ja' %}例: 1,000,000{% elif lang == 'zh' %}例如：1,000,000{% else %}예: 1,000,000{% endif %}" 
                                           required oninput="formatPrice(this)" onkeypress="return onlyNumbers(event)">
                                </div>
                                <input type="hidden" id="price_raw" name="price_raw">
                            </div>
                        </div>
                        <!-- 구매방법 체크박스 -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-shopping-cart me-1"></i>
                                {% if lang == 'en' %}Purchase Method{% elif lang == 'ja' %}購入方法{% elif lang == 'zh' %}购票方式{% else %}구매 방법{% endif %}
                                <span class="text-muted small">({% if lang == 'en' %}Multiple selection possible{% elif lang == 'ja' %}複数選択可{% elif lang == 'zh' %}可多选{% else %}중복선택 가능{% endif %})</span>
                            </label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="purchase_on_site" name="purchase_methods" value="현장구매" checked>
                                    <label class="form-check-label" for="purchase_on_site">{% if lang == 'en' %}On-site{% elif lang == 'ja' %}現地購入{% elif lang == 'zh' %}现场购票{% else %}현장구매{% endif %}</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="purchase_online" name="purchase_methods" value="사이트구매" onchange="toggleTicketUrlInput()">
                                    <label class="form-check-label" for="purchase_online">{% if lang == 'en' %}Online (Site){% elif lang == 'ja' %}サイト購入{% elif lang == 'zh' %}网站购票{% else %}사이트구매{% endif %}</label>
                                </div>
                            </div>
                        </div>
                        <!-- 사이트구매 선택 시 링크 입력란 -->
                        <div class="mb-3" id="ticketUrlInput" style="display:none;">
                            <label for="ticket_url" class="form-label">
                                <i class="fas fa-link me-1"></i>
                                {% if lang == 'en' %}Ticket Purchase Link{% elif lang == 'ja' %}購入サイトリンク{% elif lang == 'zh' %}购票链接{% else %}구매 사이트 링크{% endif %}
                            </label>
                            <input type="url" class="form-control" id="ticket_url" name="ticket_url" placeholder="https://">
                        </div>
                        <script>
                        function toggleTicketUrlInput() {
                            var online = document.getElementById('purchase_online').checked;
                            document.getElementById('ticketUrlInput').style.display = online ? '' : 'none';
                        }
                        document.addEventListener('DOMContentLoaded', function() {
                            toggleTicketUrlInput();
                        });
                        </script>

                        <!-- 상세 주소 입력 -->
                        <div class="mb-3">
                            <label for="address" class="form-label">
                                <i class="fas fa-map me-1"></i>
                                {% if lang == 'en' %}Detailed Address (for map){% elif lang == 'ja' %}詳細住所（地図用）{% elif lang == 'zh' %}详细地址（用于地图）{% else %}상세 주소 (지도 표시용){% endif %}
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="address" name="address" 
                                       placeholder="{% if lang == 'en' %}e.g. 4F, 123 Teheran-ro, Gangnam-gu, Seoul{% elif lang == 'ja' %}例: ソウル特別市江南区テヘラン路123 4階{% elif lang == 'zh' %}例如：首尔特别市江南区德黑兰路123 4层{% else %}예: 서울특별시 강남구 테헤란로 123 4층{% endif %}">
                                <button type="button" class="btn btn-outline-primary" id="searchMapBtn">
                                    <i class="fas fa-search-location"></i>
                                    {% if lang == 'en' %}Search on Map{% elif lang == 'ja' %}地図で検索{% elif lang == 'zh' %}在地图上搜索{% else %}지도에서 검색{% endif %}
                                </button>
                            </div>
                            <small class="form-text text-muted">{% if lang == 'en' %}Enter the exact address or adjust the location on the map.{% elif lang == 'ja' %}正確な住所を入力するか、地図で位置を調整してください。{% elif lang == 'zh' %}请输入准确地址或在地图上调整位置。{% else %}정확한 주소를 입력하거나 지도에서 위치를 조정하세요.{% endif %}</small>
                            <div id="map" style="width:100%;height:350px;" class="map-container mt-3"></div>
                        </div>
                        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=79ded8e1559559f4771806999c7c04ab&libraries=services" onerror="alert('카카오맵 API 로드에 실패했습니다. 새로고침 해보세요.')"></script>
                        <script>
                        // 세부 카테고리 업데이트 함수
                        function updateSubCategories() {
                            const mainCategory = document.getElementById('main_category').value;
                            const categorySelect = document.getElementById('category');
                            
                            // 기존 옵션 제거
                            categorySelect.innerHTML = '<option value="">{% if lang == "en" %}Select subcategory after main category{% elif lang == "ja" %}メインカテゴリを先に選択{% elif lang == "zh" %}请先选择主类别{% else %}먼저 메인 카테고리를 선택하세요{% endif %}</option>';
                            
                            if (mainCategory === '공연') {
                                const performanceCategories = [
                                    '연극', '뮤지컬', '서양음악(클래식)', '한국음악(국악)', 
                                    '대중음악', '무용(서양/한국무용)', '대중무용', '서커스/마술', '복합'
                                ];
                                performanceCategories.forEach(cat => {
                                    const option = document.createElement('option');
                                    option.value = cat;
                                    option.textContent = cat;
                                    categorySelect.appendChild(option);
                                });
                            } else if (mainCategory === '대회') {
                                const competitionCategories = [
                                    '댄스대회', '노래대회', '연기대회', '음악대회', '무용대회', '종합예술대회'
                                ];
                                competitionCategories.forEach(cat => {
                                    const option = document.createElement('option');
                                    option.value = cat;
                                    option.textContent = cat;
                                    categorySelect.appendChild(option);
                                });
                            }
                        }
                        
                        let map, marker, geocoder, infowindow;
                        
                        // 지역 자동 감지 함수
                        function detectRegionFromAddress(address) {
                            if (!address) return null;
                            
                            const addressLower = address.toLowerCase();
                            const regionMapping = {
                                '서울특별시': ['서울특별시', '서울시', '서울'],
                                '경기도': ['경기도', '경기'],
                                '강원도': ['강원도', '강원'],
                                '인천광역시': ['인천광역시', '인천시', '인천'],
                                '충청남도': ['충청남도', '충남'],
                                '충청북도': ['충청북도', '충북'],
                                '세종특별자치시': ['세종특별자치시', '세종시', '세종'],
                                '대전광역시': ['대전광역시', '대전시', '대전'],
                                '경상북도': ['경상북도', '경북'],
                                '대구광역시': ['대구광역시', '대구시', '대구'],
                                '전라북도': ['전라북도', '전북'],
                                '경상남도': ['경상남도', '경남'],
                                '울산광역시': ['울산광역시', '울산시', '울산'],
                                '부산광역시': ['부산광역시', '부산시', '부산'],
                                '광주광역시': ['광주광역시', '광주시', '광주'],
                                '전라남도': ['전라남도', '전남'],
                                '제주도': ['제주도', '제주특별자치도', '제주시', '제주']
                            };
                            
                            for (const [region, keywords] of Object.entries(regionMapping)) {
                                for (const keyword of keywords) {
                                    if (addressLower.includes(keyword)) {
                                        return region;
                                    }
                                }
                            }
                            return null;
                        }
                        
                        function initMap() {
                            if (!window.kakao || !window.kakao.maps) {
                                alert('카카오맵 API가 정상적으로 로드되지 않았습니다. 새로고침 해보세요.');
                                return;
                            }
                            geocoder = new kakao.maps.services.Geocoder();
                            infowindow = new kakao.maps.InfoWindow({zindex:1});
                            map = new kakao.maps.Map(document.getElementById('map'), {
                                center: new kakao.maps.LatLng(37.5665, 126.9780),
                                level: 3
                            });
                            marker = new kakao.maps.Marker({
                                position: map.getCenter(),
                                map: map,
                                draggable: true
                            });
                            kakao.maps.event.addListener(marker, 'dragend', function() {
                                let pos = marker.getPosition();
                                geocoder.coord2Address(pos.getLng(), pos.getLat(), function(result, status) {
                                    if (status === kakao.maps.services.Status.OK) {
                                        let addr = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                                        document.getElementById('address').value = addr;
                                        // 주소 변경 시 지역 자동 감지
                                        const detectedRegion = detectRegionFromAddress(addr);
                                        if (detectedRegion) {
                                            document.getElementById('location').value = detectedRegion;
                                            showRegionNotification(detectedRegion);
                                        }
                                        infowindow.setContent('<div style="font-size:13px;">' + addr + '</div>');
                                        infowindow.open(map, marker);
                                    }
                                });
                            });
                        }
                        
                        // 지역 감지 알림 표시
                        function showRegionNotification(region) {
                            // 기존 알림 제거
                            const existingAlert = document.querySelector('.region-alert');
                            if (existingAlert) {
                                existingAlert.remove();
                            }
                            
                            // 새 알림 생성
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-info alert-dismissible fade show region-alert';
                            alertDiv.innerHTML = `
                                <i class="fas fa-map-marker-alt me-2"></i>
                                {% if lang == "en" %}Address region detected automatically: <strong>${region}</strong>{% elif lang == "ja" %}住所から地域が自動検出されました: <strong>${region}</strong>{% elif lang == "zh" %}地址自动检测到地区: <strong>${region}</strong>{% else %}주소에서 지역이 자동으로 감지되었습니다: <strong>${region}</strong>{% endif %}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            
                            // 폼 상단에 알림 추가
                            const form = document.querySelector('form');
                            form.insertBefore(alertDiv, form.firstChild);
                            
                            // 5초 후 자동 제거
                            setTimeout(() => {
                                if (alertDiv.parentNode) {
                                    alertDiv.remove();
                                }
                            }, 5000);
                        }
                        
                        document.addEventListener('DOMContentLoaded', function() {
                            initMap();
                            
                            // 주소 입력 필드에 이벤트 리스너 추가
                            const addressInput = document.getElementById('address');
                            addressInput.addEventListener('input', function() {
                                const detectedRegion = detectRegionFromAddress(this.value);
                                if (detectedRegion) {
                                    document.getElementById('location').value = detectedRegion;
                                    showRegionNotification(detectedRegion);
                                }
                            });
                            
                            document.getElementById('searchMapBtn').onclick = function() {
                                console.log('지도 검색 버튼 클릭됨');
                                let addr = document.getElementById('address').value;
                                if (!addr) {
                                    alert('{% if lang == "en" %}Please enter an address or place name!{% elif lang == "ja" %}住所または場所名を入力してください！{% elif lang == "zh" %}请输入地址或地点名称！{% else %}주소나 장소명을 입력하세요!{% endif %}');
                                    return;
                                }
                                // 1차: addressSearch (도로명/지번 주소)
                                geocoder.addressSearch(addr, function(result, status) {
                                    if (status === kakao.maps.services.Status.OK) {
                                        let coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                                        map.setCenter(coords);
                                        marker.setPosition(coords);
                                        infowindow.setContent('<div style="font-size:13px;">' + addr + '</div>');
                                        infowindow.open(map, marker);
                                        
                                        // 주소 변경 시 지역 자동 감지
                                        const detectedRegion = detectRegionFromAddress(addr);
                                        if (detectedRegion) {
                                            document.getElementById('location').value = detectedRegion;
                                            showRegionNotification(detectedRegion);
                                        }
                                        
                                        alert('{% if lang == "en" %}Map moved to the specified location!{% elif lang == "ja" %}地図が指定された位置に移動しました！{% elif lang == "zh" %}地图已移动到指定位置！{% else %}지도가 해당 위치로 이동했습니다!{% endif %}');
                                    } else {
                                        // 2차: keywordSearch (장소명, 기관명 등)
                                        let ps = new kakao.maps.services.Places();
                                        ps.keywordSearch(addr, function(data, status2) {
                                            if (status2 === kakao.maps.services.Status.OK && data.length > 0) {
                                                let coords = new kakao.maps.LatLng(data[0].y, data[0].x);
                                                map.setCenter(coords);
                                                marker.setPosition(coords);
                                                infowindow.setContent('<div style="font-size:13px;">' + data[0].place_name + '</div>');
                                                infowindow.open(map, marker);
                                                
                                                const newAddress = data[0].road_address_name || data[0].address_name || data[0].place_name;
                                                document.getElementById('address').value = newAddress;
                                                
                                                // 주소 변경 시 지역 자동 감지
                                                const detectedRegion = detectRegionFromAddress(newAddress);
                                                if (detectedRegion) {
                                                    document.getElementById('location').value = detectedRegion;
                                                    showRegionNotification(detectedRegion);
                                                }
                                                
                                                alert('{% if lang == "en" %}Map moved to the specified location!{% elif lang == "ja" %}地図が指定された位置に移動しました！{% elif lang == "zh" %}地图已移动到指定位置！{% else %}지도가 해당 장소로 이동했습니다!{% endif %}');
                                            } else {
                                                alert('{% if lang == "en" %}Could not find address or place name. Please try entering a road address or a more accurate place name.{% elif lang == "ja" %}住所または場所名が見つかりませんでした。道路住所またはより正確な場所名を入力してください。{% elif lang == "zh" %}无法找到地址或地点名称。请尝试输入道路地址或更准确的地点名称。{% else %}주소 또는 장소명을 찾을 수 없습니다. 도로명 주소나 정확한 장소명을 입력해보세요.{% endif %}');
                                            }
                                        });
                                    }
                                });
                            };
                        });
                        </script>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="date" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>
                                    {% if lang == 'en' %}Date *{% elif lang == 'ja' %}日付 *{% elif lang == 'zh' %}日期 *{% else %}공연 날짜 *{% endif %}
                                </label>
                                <input type="date" class="form-control" id="date" name="date" required min="{{ today_date }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-clock me-1"></i>
                                    {% if lang == 'en' %}Time *{% elif lang == 'ja' %}時間 *{% elif lang == 'zh' %}时间 *{% else %}공연 시간 *{% endif %}
                                </label>
                                <div class="d-flex gap-2 align-items-center">
                                    <select class="form-select" id="start_time" name="start_time" required>
                                        <option value="">{% if lang == 'en' %}Start Time{% elif lang == 'ja' %}開始時間{% elif lang == 'zh' %}开始时间{% else %}시작 시간{% endif %}</option>
                                        {% for h in range(10,24) %}
                                            <option value="{{'%02d:00' % h}}">{{'%02d:00' % h}}</option>
                                            <option value="{{'%02d:30' % h}}">{{'%02d:30' % h}}</option>
                                        {% endfor %}
                                    </select>
                                    <span>~</span>
                                    <select class="form-select" id="end_time" name="end_time" required>
                                        <option value="">{% if lang == 'en' %}End Time{% elif lang == 'ja' %}終了時間{% elif lang == 'zh' %}结束时间{% else %}종료 시간{% endif %}</option>
                                        {% for h in range(10,24) %}
                                            <option value="{{'%02d:00' % h}}">{{'%02d:00' % h}}</option>
                                            <option value="{{'%02d:30' % h}}">{{'%02d:30' % h}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contact_email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>
                                    {% if lang == 'en' %}Contact Email *{% elif lang == 'ja' %}連絡先メール *{% elif lang == 'zh' %}联系邮箱 *{% else %}연락처 이메일 *{% endif %}
                                </label>
                                <input type="email" class="form-control" id="contact_email" name="contact_email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="video_url" class="form-label">
                                    <i class="fas fa-video me-1"></i>
                                    {% if lang == 'en' %}Promo Video URL (optional){% elif lang == 'ja' %}プロモーション動画URL（任意）{% elif lang == 'zh' %}宣传视频链接（可选）{% else %}홍보 동영상 URL (선택){% endif %}
                                </label>
                                <input type="url" class="form-control" id="video_url" name="video_url" 
                                       placeholder="{% if lang == 'en' %}YouTube, Vimeo, etc.{% elif lang == 'ja' %}YouTube、Vimeoなど{% elif lang == 'zh' %}YouTube、Vimeo等{% else %}YouTube, Vimeo 등 동영상 링크{% endif %}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="ticket_url" class="form-label">
                                <i class="fas fa-ticket-alt me-1"></i>
                                {% if lang == 'en' %}Ticket Booking Link (optional){% elif lang == 'ja' %}チケット予約リンク（任意）{% elif lang == 'zh' %}购票链接（可选）{% else %}티켓 예매 링크 (선택){% endif %}
                            </label>
                            <input type="url" class="form-control" id="ticket_url" name="ticket_url" 
                                   placeholder="{% if lang == 'en' %}e.g. Interpark, Yes24, etc.{% elif lang == 'ja' %}例: インターパーク、イエス24など{% elif lang == 'zh' %}例如：Interpark、Yes24等{% else %}예매 사이트 링크 (예: 인터파크, 예스24 등){% endif %}">
                        </div>

                        <div class="mb-4">
                            <label for="image_file" class="form-label">
                                <i class="fas fa-image me-1"></i>
                                {% if lang == 'en' %}Upload Promo Image (drag & drop or click){% elif lang == 'ja' %}プロモーション画像アップロード（ドラッグ＆ドロップまたはクリック）{% elif lang == 'zh' %}上传宣传图片（拖拽或点击）{% else %}홍보 이미지 업로드 (드래그&드롭 또는 클릭){% endif %}
                            </label>
                            <div id="dropzone" class="border border-2 border-primary rounded p-4 text-center bg-light" style="cursor:pointer;">
                                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                <div>{% if lang == 'en' %}Drag or click here to attach an image{% elif lang == 'ja' %}ここに画像をドラッグまたはクリックして添付{% elif lang == 'zh' %}将图片拖到此处或点击以添加{% else %}이미지를 여기에 드래그하거나 클릭해서 첨부하세요{% endif %}</div>
                                <input type="file" class="form-control d-none" id="image_file" name="image_file" accept="image/*">
                                <img id="preview" src="#" alt="미리보기" class="img-fluid mt-3 d-none" style="max-height:200px;"/>
                            </div>
                        </div>
                        <script>
                            // 가격 포맷팅 함수
                            function formatPrice(input) {
                                // 숫자가 아닌 문자 제거
                                let value = input.value.replace(/[^\d]/g, '');
                                
                                // 숫자가 없으면 빈 문자열 반환
                                if (value === '') {
                                    input.value = '';
                                    document.getElementById('price_raw').value = '';
                                    return;
                                }
                                
                                // 숫자를 3자리마다 콤마로 구분
                                const formattedValue = parseInt(value).toLocaleString();
                                input.value = formattedValue;
                                
                                // 원본 숫자 값을 hidden 필드에 저장
                                document.getElementById('price_raw').value = value;
                            }
                            
                            // 숫자만 입력 허용
                            function onlyNumbers(event) {
                                const charCode = (event.which) ? event.which : event.keyCode;
                                if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                                    return false;
                                }
                                return true;
                            }
                            
                            // 폼 제출 시 원본 숫자 값 사용
                            document.addEventListener('DOMContentLoaded', function() {
                                const form = document.querySelector('form');
                                form.addEventListener('submit', function(e) {
                                    const priceInput = document.getElementById('price');
                                    const priceRaw = document.getElementById('price_raw');
                                    
                                    // 콤마가 포함된 표시용 값을 원본 숫자로 교체
                                    if (priceRaw.value) {
                                        priceInput.value = priceRaw.value;
                                    }
                                });
                            });
                            
                            const dropzone = document.getElementById('dropzone');
                            const fileInput = document.getElementById('image_file');
                            const preview = document.getElementById('preview');
                            dropzone.addEventListener('click', () => fileInput.click());
                            dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('bg-primary', 'text-white'); });
                            dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('bg-primary', 'text-white'); });
                            dropzone.addEventListener('drop', e => {
                                e.preventDefault();
                                dropzone.classList.remove('bg-primary', 'text-white');
                                fileInput.files = e.dataTransfer.files;
                                showPreview();
                            });
                            fileInput.addEventListener('change', showPreview);
                            function showPreview() {
                                if (fileInput.files && fileInput.files[0]) {
                                    const reader = new FileReader();
                                    reader.onload = e => {
                                        preview.src = e.target.result;
                                        preview.classList.remove('d-none');
                                    };
                                    reader.readAsDataURL(fileInput.files[0]);
                                }
                            }
                        </script>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>
                                {% if lang == 'en' %}Submit{% elif lang == 'ja' %}申請{% elif lang == 'zh' %}提交{% else %}공연 신청하기{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>
                        {% if lang == 'en' %}Submission Guide{% elif lang == 'ja' %}申請案内{% elif lang == 'zh' %}申请须知{% else %}신청 안내사항{% endif %}
                    </h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>{% if lang == 'en' %}Your submission will be reviewed and approved{% elif lang == 'ja' %}申請後、審査を経て承認されます{% elif lang == 'zh' %}申请后将经过审核并批准{% else %}신청 후 검토를 거쳐 승인됩니다{% endif %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% if lang == 'en' %}Approval status will be notified by email{% elif lang == 'ja' %}承認可否はメールでお知らせします{% elif lang == 'zh' %}审核结果将通过邮件通知{% else %}승인 여부는 이메일로 알려드립니다{% endif %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% if lang == 'en' %}Promo video and image are optional{% elif lang == 'ja' %}プロモーション動画と画像は任意です{% elif lang == 'zh' %}宣传视频和图片为可选项{% else %}홍보 동영상과 이미지는 선택사항입니다{% endif %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% if lang == 'en' %}Please enter accurate information{% elif lang == 'ja' %}正確な情報を入力してください{% elif lang == 'zh' %}请填写准确的信息{% else %}정확한 정보를 입력해주세요{% endif %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 