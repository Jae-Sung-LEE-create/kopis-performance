{% extends "base.html" %}

{% block title %}공연 신청 - KOPIS 공연 홍보 플랫폼{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-plus me-2"></i>공연 신청
                    </h3>
                </div>
                <div class="card-body p-4">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="/submit" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="title" class="form-label">
                                    <i class="fas fa-music me-1"></i>공연 제목 *
                                </label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="group_name" class="form-label">
                                    <i class="fas fa-users me-1"></i>팀/크루명 *
                                </label>
                                <input type="text" class="form-control" id="group_name" name="group_name" required>
                            </div>
                        </div>

                        <!-- 카테고리 선택 추가 -->
                        <div class="mb-3">
                            <label for="category" class="form-label">
                                <i class="fas fa-list me-1"></i>카테고리 *
                            </label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">카테고리를 선택하세요</option>
                                <option value="연극">연극</option>
                                <option value="뮤지컬">뮤지컬</option>
                                <option value="서양음악(클래식)">서양음악(클래식)</option>
                                <option value="한국음악(국악)">한국음악(국악)</option>
                                <option value="대중음악">대중음악</option>
                                <option value="무용(서양/한국무용)">무용(서양/한국무용)</option>
                                <option value="대중무용">대중무용</option>
                                <option value="서커스/마술">서커스/마술</option>
                                <option value="복합">복합</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>공연 소개 *
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="4" 
                                      placeholder="공연의 특징, 구성, 댄스 스타일 등을 자세히 설명해주세요" required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="location" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>공연 장소 *
                                </label>
                                <input type="text" class="form-control" id="location" name="location" 
                                       placeholder="예: 서울시 강남구 XX공연장" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="price" class="form-label">
                                    <i class="fas fa-ticket-alt me-1"></i>티켓 가격 *
                                </label>
                                <input type="text" class="form-control" id="price" name="price" 
                                       placeholder="예: 무료, 10,000원, 학생할인" required>
                            </div>
                        </div>

                        <!-- 상세 주소 입력 -->
                        <div class="mb-3">
                            <label for="address" class="form-label">
                                <i class="fas fa-map me-1"></i>상세 주소 (지도 표시용)
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="address" name="address" 
                                       placeholder="예: 서울특별시 강남구 테헤란로 123 4층">
                                <button type="button" class="btn btn-outline-primary" id="searchMapBtn">
                                    <i class="fas fa-search-location"></i> 지도에서 검색
                                </button>
                            </div>
                            <small class="form-text text-muted">정확한 주소를 입력하거나 지도에서 위치를 조정하세요.</small>
                            <div id="map" style="width:100%;height:350px;" class="map-container mt-3"></div>
                        </div>
                        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=79ded8e1559559f4771806999c7c04ab&libraries=services" onerror="alert('카카오맵 API 로드에 실패했습니다. 새로고침 해보세요.')"></script>
                        <script>
                        let map, marker, geocoder, infowindow;
                        function initMap() {
                            if (!window.kakao || !window.kakao.maps) {
                                alert('카카오맵 API가 정상적으로 로드되지 않았습니다. 새로고침 해보세요.');
                                return;
                            }
                            geocoder = new kakao.maps.services.Geocoder();
                            infowindow = new kakao.maps.InfoWindow({zindex:1});
                            map = new kakao.maps.Map(document.getElementById('map'), {
                                center: new kakao.maps.LatLng(37.5665, 126.9780),
                                level: 3
                            });
                            marker = new kakao.maps.Marker({
                                position: map.getCenter(),
                                map: map,
                                draggable: true
                            });
                            kakao.maps.event.addListener(marker, 'dragend', function() {
                                let pos = marker.getPosition();
                                geocoder.coord2Address(pos.getLng(), pos.getLat(), function(result, status) {
                                    if (status === kakao.maps.services.Status.OK) {
                                        let addr = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                                        document.getElementById('address').value = addr;
                                        infowindow.setContent('<div style="font-size:13px;">' + addr + '</div>');
                                        infowindow.open(map, marker);
                                    }
                                });
                            });
                        }
                        document.addEventListener('DOMContentLoaded', function() {
                            initMap();
                            document.getElementById('searchMapBtn').onclick = function() {
                                console.log('지도 검색 버튼 클릭됨');
                                let addr = document.getElementById('address').value;
                                if (!addr) {
                                    alert('주소를 입력하세요!');
                                    return;
                                }
                                geocoder.addressSearch(addr, function(result, status) {
                                    if (status === kakao.maps.services.Status.OK) {
                                        let coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                                        map.setCenter(coords);
                                        marker.setPosition(coords);
                                        infowindow.setContent('<div style="font-size:13px;">' + addr + '</div>');
                                        infowindow.open(map, marker);
                                        alert('지도가 해당 위치로 이동했습니다!');
                                    } else {
                                        alert('주소를 찾을 수 없습니다. 도로명 주소를 입력해보세요.');
                                    }
                                });
                            };
                        });
                        </script>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="date" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>공연 날짜 *
                                </label>
                                <input type="date" class="form-control" id="date" name="date" required min="{{ today_date }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-clock me-1"></i>공연 시간 *
                                </label>
                                <div class="d-flex gap-2 align-items-center">
                                    <select class="form-select" id="start_time" name="start_time" required>
                                        <option value="">시작 시간</option>
                                        {% for h in range(10,24) %}
                                            <option value="{{'%02d:00' % h}}">{{'%02d:00' % h}}</option>
                                            <option value="{{'%02d:30' % h}}">{{'%02d:30' % h}}</option>
                                        {% endfor %}
                                    </select>
                                    <span>~</span>
                                    <select class="form-select" id="end_time" name="end_time" required>
                                        <option value="">종료 시간</option>
                                        {% for h in range(10,24) %}
                                            <option value="{{'%02d:00' % h}}">{{'%02d:00' % h}}</option>
                                            <option value="{{'%02d:30' % h}}">{{'%02d:30' % h}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contact_email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>연락처 이메일 *
                                </label>
                                <input type="email" class="form-control" id="contact_email" name="contact_email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="video_url" class="form-label">
                                    <i class="fas fa-video me-1"></i>홍보 동영상 URL (선택)
                                </label>
                                <input type="url" class="form-control" id="video_url" name="video_url" 
                                       placeholder="YouTube, Vimeo 등 동영상 링크">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="ticket_url" class="form-label">
                                <i class="fas fa-ticket-alt me-1"></i>티켓 예매 링크 (선택)
                            </label>
                            <input type="url" class="form-control" id="ticket_url" name="ticket_url" 
                                   placeholder="예매 사이트 링크 (예: 인터파크, 예스24 등)">
                        </div>

                        <div class="mb-4">
                            <label for="image_file" class="form-label">
                                <i class="fas fa-image me-1"></i>홍보 이미지 업로드 (드래그&드롭 또는 클릭)
                            </label>
                            <div id="dropzone" class="border border-2 border-primary rounded p-4 text-center bg-light" style="cursor:pointer;">
                                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                <div>이미지를 여기에 드래그하거나 클릭해서 첨부하세요</div>
                                <input type="file" class="form-control d-none" id="image_file" name="image_file" accept="image/*">
                                <img id="preview" src="#" alt="미리보기" class="img-fluid mt-3 d-none" style="max-height:200px;"/>
                            </div>
                        </div>
                        <script>
                            const dropzone = document.getElementById('dropzone');
                            const fileInput = document.getElementById('image_file');
                            const preview = document.getElementById('preview');
                            dropzone.addEventListener('click', () => fileInput.click());
                            dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('bg-primary', 'text-white'); });
                            dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('bg-primary', 'text-white'); });
                            dropzone.addEventListener('drop', e => {
                                e.preventDefault();
                                dropzone.classList.remove('bg-primary', 'text-white');
                                fileInput.files = e.dataTransfer.files;
                                showPreview();
                            });
                            fileInput.addEventListener('change', showPreview);
                            function showPreview() {
                                if (fileInput.files && fileInput.files[0]) {
                                    const reader = new FileReader();
                                    reader.onload = e => {
                                        preview.src = e.target.result;
                                        preview.classList.remove('d-none');
                                    };
                                    reader.readAsDataURL(fileInput.files[0]);
                                }
                            }
                        </script>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>공연 신청하기
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>신청 안내사항
                    </h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>신청 후 검토를 거쳐 승인됩니다</li>
                        <li><i class="fas fa-check text-success me-2"></i>승인 여부는 이메일로 알려드립니다</li>
                        <li><i class="fas fa-check text-success me-2"></i>홍보 동영상과 이미지는 선택사항입니다</li>
                        <li><i class="fas fa-check text-success me-2"></i>정확한 정보를 입력해주세요</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 