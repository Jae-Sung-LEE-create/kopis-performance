{% extends "base.html" %}

{% block title %}공연 신청 - KOPIS 공연 홍보 플랫폼{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-plus me-2"></i>공연 신청
                    </h3>
                </div>
                <div class="card-body p-4">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="/submit" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="title" class="form-label">
                                    <i class="fas fa-music me-1"></i>공연 제목 *
                                </label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="group_name" class="form-label">
                                    <i class="fas fa-users me-1"></i>팀/크루명 *
                                </label>
                                <input type="text" class="form-control" id="group_name" name="group_name" required>
                            </div>
                        </div>

                        <!-- 카테고리 선택 추가 -->
                        <div class="mb-3">
                            <label for="category" class="form-label">
                                <i class="fas fa-list me-1"></i>카테고리 *
                            </label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">카테고리를 선택하세요</option>
                                <option value="연극">연극</option>
                                <option value="뮤지컬">뮤지컬</option>
                                <option value="서양음악(클래식)">서양음악(클래식)</option>
                                <option value="한국음악(국악)">한국음악(국악)</option>
                                <option value="대중음악">대중음악</option>
                                <option value="무용(서양/한국무용)">무용(서양/한국무용)</option>
                                <option value="대중무용">대중무용</option>
                                <option value="서커스/마술">서커스/마술</option>
                                <option value="복합">복합</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>공연 소개 *
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="4" 
                                      placeholder="공연의 특징, 구성, 댄스 스타일 등을 자세히 설명해주세요" required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="location" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>지역 *
                                </label>
                                <select class="form-select" id="location" name="location" required>
                                    <option value="">지역을 선택하세요</option>
                                    <option value="서울특별시">서울특별시</option>
                                    <option value="경기도">경기도</option>
                                    <option value="강원도">강원도</option>
                                    <option value="인천광역시">인천광역시</option>
                                    <option value="충청남도">충청남도</option>
                                    <option value="충청북도">충청북도</option>
                                    <option value="세종특별자치시">세종특별자치시</option>
                                    <option value="대전광역시">대전광역시</option>
                                    <option value="경상북도">경상북도</option>
                                    <option value="대구광역시">대구광역시</option>
                                    <option value="전라북도">전라북도</option>
                                    <option value="경상남도">경상남도</option>
                                    <option value="울산광역시">울산광역시</option>
                                    <option value="부산광역시">부산광역시</option>
                                    <option value="광주광역시">광주광역시</option>
                                    <option value="전라남도">전라남도</option>
                                    <option value="제주도">제주도</option>
                                </select>
                                <small class="form-text text-muted">주소를 입력하면 자동으로 지역이 설정됩니다.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="price" class="form-label">
                                    <i class="fas fa-ticket-alt me-1"></i>티켓 가격 *
                                </label>
                                <input type="text" class="form-control" id="price" name="price" 
                                       placeholder="예: 무료, 10,000원, 학생할인" required>
                            </div>
                        </div>

                        <!-- 상세 주소 입력 -->
                        <div class="mb-3">
                            <label for="address" class="form-label">
                                <i class="fas fa-map me-1"></i>상세 주소 (지도 표시용)
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="address" name="address" 
                                       placeholder="예: 서울특별시 강남구 테헤란로 123 4층">
                                <button type="button" class="btn btn-outline-primary" id="searchMapBtn">
                                    <i class="fas fa-search-location"></i> 지도에서 검색
                                </button>
                            </div>
                            <small class="form-text text-muted">정확한 주소를 입력하거나 지도에서 위치를 조정하세요.</small>
                            <div id="map" style="width:100%;height:350px;" class="map-container mt-3"></div>
                        </div>
                        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=79ded8e1559559f4771806999c7c04ab&libraries=services" onerror="alert('카카오맵 API 로드에 실패했습니다. 새로고침 해보세요.')"></script>
                        <script>
                        let map, marker, geocoder, infowindow;
                        
                        // 지역 자동 감지 함수
                        function detectRegionFromAddress(address) {
                            if (!address) return null;
                            
                            const addressLower = address.toLowerCase();
                            const regionMapping = {
                                '서울특별시': ['서울특별시', '서울시', '서울'],
                                '경기도': ['경기도', '경기'],
                                '강원도': ['강원도', '강원'],
                                '인천광역시': ['인천광역시', '인천시', '인천'],
                                '충청남도': ['충청남도', '충남'],
                                '충청북도': ['충청북도', '충북'],
                                '세종특별자치시': ['세종특별자치시', '세종시', '세종'],
                                '대전광역시': ['대전광역시', '대전시', '대전'],
                                '경상북도': ['경상북도', '경북'],
                                '대구광역시': ['대구광역시', '대구시', '대구'],
                                '전라북도': ['전라북도', '전북'],
                                '경상남도': ['경상남도', '경남'],
                                '울산광역시': ['울산광역시', '울산시', '울산'],
                                '부산광역시': ['부산광역시', '부산시', '부산'],
                                '광주광역시': ['광주광역시', '광주시', '광주'],
                                '전라남도': ['전라남도', '전남'],
                                '제주도': ['제주도', '제주특별자치도', '제주시', '제주']
                            };
                            
                            for (const [region, keywords] of Object.entries(regionMapping)) {
                                for (const keyword of keywords) {
                                    if (addressLower.includes(keyword)) {
                                        return region;
                                    }
                                }
                            }
                            return null;
                        }
                        
                        function initMap() {
                            if (!window.kakao || !window.kakao.maps) {
                                alert('카카오맵 API가 정상적으로 로드되지 않았습니다. 새로고침 해보세요.');
                                return;
                            }
                            geocoder = new kakao.maps.services.Geocoder();
                            infowindow = new kakao.maps.InfoWindow({zindex:1});
                            map = new kakao.maps.Map(document.getElementById('map'), {
                                center: new kakao.maps.LatLng(37.5665, 126.9780),
                                level: 3
                            });
                            marker = new kakao.maps.Marker({
                                position: map.getCenter(),
                                map: map,
                                draggable: true
                            });
                            kakao.maps.event.addListener(marker, 'dragend', function() {
                                let pos = marker.getPosition();
                                geocoder.coord2Address(pos.getLng(), pos.getLat(), function(result, status) {
                                    if (status === kakao.maps.services.Status.OK) {
                                        let addr = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                                        document.getElementById('address').value = addr;
                                        // 주소 변경 시 지역 자동 감지
                                        const detectedRegion = detectRegionFromAddress(addr);
                                        if (detectedRegion) {
                                            document.getElementById('location').value = detectedRegion;
                                            showRegionNotification(detectedRegion);
                                        }
                                        infowindow.setContent('<div style="font-size:13px;">' + addr + '</div>');
                                        infowindow.open(map, marker);
                                    }
                                });
                            });
                        }
                        
                        // 지역 감지 알림 표시
                        function showRegionNotification(region) {
                            // 기존 알림 제거
                            const existingAlert = document.querySelector('.region-alert');
                            if (existingAlert) {
                                existingAlert.remove();
                            }
                            
                            // 새 알림 생성
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-info alert-dismissible fade show region-alert';
                            alertDiv.innerHTML = `
                                <i class="fas fa-map-marker-alt me-2"></i>
                                주소에서 지역이 자동으로 감지되었습니다: <strong>${region}</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            
                            // 폼 상단에 알림 추가
                            const form = document.querySelector('form');
                            form.insertBefore(alertDiv, form.firstChild);
                            
                            // 5초 후 자동 제거
                            setTimeout(() => {
                                if (alertDiv.parentNode) {
                                    alertDiv.remove();
                                }
                            }, 5000);
                        }
                        
                        document.addEventListener('DOMContentLoaded', function() {
                            initMap();
                            
                            // 주소 입력 필드에 이벤트 리스너 추가
                            const addressInput = document.getElementById('address');
                            addressInput.addEventListener('input', function() {
                                const detectedRegion = detectRegionFromAddress(this.value);
                                if (detectedRegion) {
                                    document.getElementById('location').value = detectedRegion;
                                    showRegionNotification(detectedRegion);
                                }
                            });
                            
                            document.getElementById('searchMapBtn').onclick = function() {
                                console.log('지도 검색 버튼 클릭됨');
                                let addr = document.getElementById('address').value;
                                if (!addr) {
                                    alert('주소나 장소명을 입력하세요!');
                                    return;
                                }
                                // 1차: addressSearch (도로명/지번 주소)
                                geocoder.addressSearch(addr, function(result, status) {
                                    if (status === kakao.maps.services.Status.OK) {
                                        let coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                                        map.setCenter(coords);
                                        marker.setPosition(coords);
                                        infowindow.setContent('<div style="font-size:13px;">' + addr + '</div>');
                                        infowindow.open(map, marker);
                                        
                                        // 주소 변경 시 지역 자동 감지
                                        const detectedRegion = detectRegionFromAddress(addr);
                                        if (detectedRegion) {
                                            document.getElementById('location').value = detectedRegion;
                                            showRegionNotification(detectedRegion);
                                        }
                                        
                                        alert('지도가 해당 위치로 이동했습니다!');
                                    } else {
                                        // 2차: keywordSearch (장소명, 기관명 등)
                                        let ps = new kakao.maps.services.Places();
                                        ps.keywordSearch(addr, function(data, status2) {
                                            if (status2 === kakao.maps.services.Status.OK && data.length > 0) {
                                                let coords = new kakao.maps.LatLng(data[0].y, data[0].x);
                                                map.setCenter(coords);
                                                marker.setPosition(coords);
                                                infowindow.setContent('<div style="font-size:13px;">' + data[0].place_name + '</div>');
                                                infowindow.open(map, marker);
                                                
                                                const newAddress = data[0].road_address_name || data[0].address_name || data[0].place_name;
                                                document.getElementById('address').value = newAddress;
                                                
                                                // 주소 변경 시 지역 자동 감지
                                                const detectedRegion = detectRegionFromAddress(newAddress);
                                                if (detectedRegion) {
                                                    document.getElementById('location').value = detectedRegion;
                                                    showRegionNotification(detectedRegion);
                                                }
                                                
                                                alert('지도가 해당 장소로 이동했습니다!');
                                            } else {
                                                alert('주소 또는 장소명을 찾을 수 없습니다. 도로명 주소나 정확한 장소명을 입력해보세요.');
                                            }
                                        });
                                    }
                                });
                            };
                        });
                        </script>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="date" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>공연 날짜 *
                                </label>
                                <input type="date" class="form-control" id="date" name="date" required min="{{ today_date }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-clock me-1"></i>공연 시간 *
                                </label>
                                <div class="d-flex gap-2 align-items-center">
                                    <select class="form-select" id="start_time" name="start_time" required>
                                        <option value="">시작 시간</option>
                                        {% for h in range(10,24) %}
                                            <option value="{{'%02d:00' % h}}">{{'%02d:00' % h}}</option>
                                            <option value="{{'%02d:30' % h}}">{{'%02d:30' % h}}</option>
                                        {% endfor %}
                                    </select>
                                    <span>~</span>
                                    <select class="form-select" id="end_time" name="end_time" required>
                                        <option value="">종료 시간</option>
                                        {% for h in range(10,24) %}
                                            <option value="{{'%02d:00' % h}}">{{'%02d:00' % h}}</option>
                                            <option value="{{'%02d:30' % h}}">{{'%02d:30' % h}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contact_email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>연락처 이메일 *
                                </label>
                                <input type="email" class="form-control" id="contact_email" name="contact_email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="video_url" class="form-label">
                                    <i class="fas fa-video me-1"></i>홍보 동영상 URL (선택)
                                </label>
                                <input type="url" class="form-control" id="video_url" name="video_url" 
                                       placeholder="YouTube, Vimeo 등 동영상 링크">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="ticket_url" class="form-label">
                                <i class="fas fa-ticket-alt me-1"></i>티켓 예매 링크 (선택)
                            </label>
                            <input type="url" class="form-control" id="ticket_url" name="ticket_url" 
                                   placeholder="예매 사이트 링크 (예: 인터파크, 예스24 등)">
                        </div>

                        <div class="mb-4">
                            <label for="image_file" class="form-label">
                                <i class="fas fa-image me-1"></i>홍보 이미지 업로드 (드래그&드롭 또는 클릭)
                            </label>
                            <div id="dropzone" class="border border-2 border-primary rounded p-4 text-center bg-light" style="cursor:pointer;">
                                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                <div>이미지를 여기에 드래그하거나 클릭해서 첨부하세요</div>
                                <input type="file" class="form-control d-none" id="image_file" name="image_file" accept="image/*">
                                <img id="preview" src="#" alt="미리보기" class="img-fluid mt-3 d-none" style="max-height:200px;"/>
                            </div>
                        </div>
                        <script>
                            const dropzone = document.getElementById('dropzone');
                            const fileInput = document.getElementById('image_file');
                            const preview = document.getElementById('preview');
                            dropzone.addEventListener('click', () => fileInput.click());
                            dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('bg-primary', 'text-white'); });
                            dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('bg-primary', 'text-white'); });
                            dropzone.addEventListener('drop', e => {
                                e.preventDefault();
                                dropzone.classList.remove('bg-primary', 'text-white');
                                fileInput.files = e.dataTransfer.files;
                                showPreview();
                            });
                            fileInput.addEventListener('change', showPreview);
                            function showPreview() {
                                if (fileInput.files && fileInput.files[0]) {
                                    const reader = new FileReader();
                                    reader.onload = e => {
                                        preview.src = e.target.result;
                                        preview.classList.remove('d-none');
                                    };
                                    reader.readAsDataURL(fileInput.files[0]);
                                }
                            }
                        </script>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>공연 신청하기
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>신청 안내사항
                    </h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>신청 후 검토를 거쳐 승인됩니다</li>
                        <li><i class="fas fa-check text-success me-2"></i>승인 여부는 이메일로 알려드립니다</li>
                        <li><i class="fas fa-check text-success me-2"></i>홍보 동영상과 이미지는 선택사항입니다</li>
                        <li><i class="fas fa-check text-success me-2"></i>정확한 정보를 입력해주세요</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 