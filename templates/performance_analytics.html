{% extends "base.html" %}

{% block title %}공연별 성과 분석 - 관리자 패널{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-chart-bar me-2"></i>공연별 성과 분석
            </h2>
        </div>
    </div>

    <!-- 성과 요약 카드 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4 class="card-title">총 공연 수</h4>
                    <h2 class="mb-0">{{ data.performance_data|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 class="card-title">평균 전환율</h4>
                    <h2 class="mb-0">{{ "%.1f"|format(data.performance_data|map(attribute='conversion_rate')|sum / data.performance_data|length if data.performance_data else 0) }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4 class="card-title">총 조회수</h4>
                    <h2 class="mb-0">{{ data.performance_data|map(attribute='views')|sum }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 class="card-title">총 좋아요</h4>
                    <h2 class="mb-0">{{ data.performance_data|map(attribute='likes')|sum }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 공연별 성과 테이블 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>공연별 성과 상세
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>공연명</th>
                                    <th>카테고리</th>
                                    <th>조회수</th>
                                    <th>좋아요</th>
                                    <th>댓글</th>
                                    <th>전환율</th>
                                    <th>성과 등급</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for perf in data.performance_data %}
                                <tr>
                                    <td>{{ perf.title }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ perf.category }}</span>
                                    </td>
                                    <td>{{ perf.views }}</td>
                                    <td>{{ perf.likes }}</td>
                                    <td>{{ perf.comments }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if perf.conversion_rate > 5 else 'warning' if perf.conversion_rate > 2 else 'danger' }}">
                                            {{ perf.conversion_rate }}%
                                        </span>
                                    </td>
                                    <td>
                                        {% if perf.conversion_rate > 5 %}
                                        <span class="badge bg-success">A+</span>
                                        {% elif perf.conversion_rate > 3 %}
                                        <span class="badge bg-primary">A</span>
                                        {% elif perf.conversion_rate > 1 %}
                                        <span class="badge bg-warning">B</span>
                                        {% else %}
                                        <span class="badge bg-danger">C</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 성과 차트 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>카테고리별 성과
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryPerformanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>전환율 분포
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="conversionDistributionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 행동 분석 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>사용자 행동 분석
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-3">
                                <h4 class="text-primary">{{ data.user_behavior.total_sessions }}</h4>
                                <small class="text-muted">총 세션 수</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-3">
                                <h4 class="text-success">{{ data.user_behavior.avg_session_duration }}초</h4>
                                <small class="text-muted">평균 체류 시간</small>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <div class="border rounded p-3">
                                <h4 class="text-warning">{{ data.user_behavior.bounce_rate }}%</h4>
                                <small class="text-muted">이탈률</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-3">
                                <h4 class="text-info">{{ data.user_behavior.return_rate }}%</h4>
                                <small class="text-muted">재방문율</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>성과 개선 권장사항
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>상위 성과 공연 특징</h6>
                        <ul class="mb-0">
                            <li>매력적인 썸네일 이미지</li>
                            <li>감정적 호소력 있는 제목</li>
                            <li>상세한 공연 설명</li>
                            <li>적절한 가격 설정</li>
                        </ul>
                    </div>
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>개선 필요 공연</h6>
                        <ul class="mb-0">
                            <li>이미지 품질 향상</li>
                            <li>제목 최적화</li>
                            <li>설명 내용 보강</li>
                            <li>가격 전략 재검토</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 카테고리별 성과 차트
const categoryPerformanceCtx = document.getElementById('categoryPerformanceChart').getContext('2d');
const categoryPerformanceChart = new Chart(categoryPerformanceCtx, {
    type: 'doughnut',
    data: {
        labels: ['뮤지컬', '연극', '무용', '음악', '기타'],
        datasets: [{
            data: [35, 25, 20, 15, 5],
            backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)',
                'rgb(153, 102, 255)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '카테고리별 성과 분포'
            }
        }
    }
});

// 전환율 분포 차트
const conversionDistributionCtx = document.getElementById('conversionDistributionChart').getContext('2d');
const conversionDistributionChart = new Chart(conversionDistributionCtx, {
    type: 'bar',
    data: {
        labels: ['0-1%', '1-2%', '2-3%', '3-4%', '4-5%', '5%+'],
        datasets: [{
            label: '공연 수',
            data: [5, 8, 12, 6, 3, 2],
            backgroundColor: 'rgba(75, 192, 192, 0.8)'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '전환율 분포'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %} 