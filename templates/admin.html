{% extends "base.html" %}

{% block title %}관리자 패널 - KOPIS 공연 홍보 플랫폼{% endblock %}

{% block content %}
{% set lang = g.lang if g.lang else 'ko' %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-cog me-2"></i>{% if lang == 'en' %}Admin Panel{% elif lang == 'ja' %}管理者パネル{% elif lang == 'zh' %}管理员面板{% else %}관리자 패널{% endif %}
            </h2>
        </div>
    </div>

    <!-- 날짜 범위 필터 및 통계 -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>{% if lang == 'en' %}Performance Statistics & Filter{% elif lang == 'ja' %}公演統計・フィルター{% elif lang == 'zh' %}演出统计和筛选{% else %}공연 통계 및 필터{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="GET" action="/admin" id="filterForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="start_date" class="form-label">
                                    {% if lang == 'en' %}Start Date{% elif lang == 'ja' %}開始日{% elif lang == 'zh' %}开始日期{% else %}시작일{% endif %}
                                </label>
                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                       value="{{ request.args.get('start_date', '') }}">
                            </div>
                            <div class="col-md-3">
                                <label for="end_date" class="form-label">
                                    {% if lang == 'en' %}End Date{% elif lang == 'ja' %}終了日{% elif lang == 'zh' %}结束日期{% else %}종료일{% endif %}
                                </label>
                                <input type="date" class="form-control" id="end_date" name="end_date" 
                                       value="{{ request.args.get('end_date', '') }}">
                            </div>
                            <div class="col-md-3">
                                <label for="category_filter" class="form-label">
                                    {% if lang == 'en' %}Category{% elif lang == 'ja' %}カテゴリー{% elif lang == 'zh' %}类别{% else %}카테고리{% endif %}
                                </label>
                                <select class="form-select" id="category_filter" name="category_filter">
                                    <option value="">{% if lang == 'en' %}All Categories{% elif lang == 'ja' %}全カテゴリー{% elif lang == 'zh' %}所有类别{% else %}전체 카테고리{% endif %}</option>
                                    <option value="연극" {% if request.args.get('category_filter') == '연극' %}selected{% endif %}>연극</option>
                                    <option value="뮤지컬" {% if request.args.get('category_filter') == '뮤지컬' %}selected{% endif %}>뮤지컬</option>
                                    <option value="서양음악(클래식)" {% if request.args.get('category_filter') == '서양음악(클래식)' %}selected{% endif %}>서양음악(클래식)</option>
                                    <option value="한국음악(국악)" {% if request.args.get('category_filter') == '한국음악(국악)' %}selected{% endif %}>한국음악(국악)</option>
                                    <option value="대중음악" {% if request.args.get('category_filter') == '대중음악' %}selected{% endif %}>대중음악</option>
                                    <option value="무용(서양/한국무용)" {% if request.args.get('category_filter') == '무용(서양/한국무용)' %}selected{% endif %}>무용(서양/한국무용)</option>
                                    <option value="대중무용" {% if request.args.get('category_filter') == '대중무용' %}selected{% endif %}>대중무용</option>
                                    <option value="서커스/마술" {% if request.args.get('category_filter') == '서커스/마술' %}selected{% endif %}>서커스/마술</option>
                                    <option value="복합" {% if request.args.get('category_filter') == '복합' %}selected{% endif %}>복합</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-1"></i>{% if lang == 'en' %}Filter{% elif lang == 'ja' %}フィルター{% elif lang == 'zh' %}筛选{% else %}필터{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- 필터링된 통계 -->
                    {% if request.args.get('start_date') or request.args.get('end_date') or request.args.get('category_filter') %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="text-primary">
                                <i class="fas fa-chart-pie me-2"></i>{% if lang == 'en' %}Filtered Statistics{% elif lang == 'ja' %}フィルター統計{% elif lang == 'zh' %}筛选统计{% else %}필터링된 통계{% endif %}
                            </h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card text-center border-primary">
                                        <div class="card-body">
                                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                            <h6 class="card-title">{% if lang == 'en' %}Pending{% elif lang == 'ja' %}審査中{% elif lang == 'zh' %}审核中{% else %}대기 중{% endif %}</h6>
                                            <h4 class="text-warning">{{ filtered_pending_count }}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-primary">
                                        <div class="card-body">
                                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                            <h6 class="card-title">{% if lang == 'en' %}Approved{% elif lang == 'ja' %}承認済み{% elif lang == 'zh' %}已批准{% else %}승인됨{% endif %}</h6>
                                            <h4 class="text-success">{{ filtered_approved_count }}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-primary">
                                        <div class="card-body">
                                            <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                                            <h6 class="card-title">{% if lang == 'en' %}Rejected{% elif lang == 'ja' %}拒否{% elif lang == 'zh' %}拒绝{% else %}거절됨{% endif %}</h6>
                                            <h4 class="text-danger">{{ filtered_rejected_count }}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-primary">
                                        <div class="card-body">
                                            <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                            <h6 class="card-title">{% if lang == 'en' %}Total{% elif lang == 'ja' %}総数{% elif lang == 'zh' %}总计{% else %}총합{% endif %}</h6>
                                            <h4 class="text-primary">{{ filtered_total_count }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 승인 대기 중인 공연 -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-clock me-2"></i>{% if lang == 'en' %}Pending Approvals ({{ pending_performances|length }}){% elif lang == 'ja' %}承認待ち ({{ pending_performances|length }}){% elif lang == 'zh' %}待审批 ({{ pending_performances|length }}){% else %}승인 대기 중 ({{ pending_performances|length }}건){% endif %}
                        </h4>
                        {% if pending_performances %}
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success btn-sm" onclick="bulkApprove()">
                                <i class="fas fa-check me-1"></i>{% if lang == 'en' %}Bulk Approve{% elif lang == 'ja' %}一括承認{% elif lang == 'zh' %}批量批准{% else %}일괄 승인{% endif %}
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="bulkReject()">
                                <i class="fas fa-times me-1"></i>{% if lang == 'en' %}Bulk Reject{% elif lang == 'ja' %}一括拒否{% elif lang == 'zh' %}批量拒绝{% else %}일괄 거절{% endif %}
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if pending_performances %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>{% if lang == 'en' %}Image{% elif lang == 'ja' %}画像{% elif lang == 'zh' %}图片{% else %}이미지{% endif %}</th>
                                    <th>{% if lang == 'en' %}Title{% elif lang == 'ja' %}公演名{% elif lang == 'zh' %}演出名{% else %}공연명{% endif %}</th>
                                    <th>{% if lang == 'en' %}Team{% elif lang == 'ja' %}チーム名{% elif lang == 'zh' %}团队{% else %}팀명{% endif %}</th>
                                    <th>{% if lang == 'en' %}Applicant{% elif lang == 'ja' %}申請者{% elif lang == 'zh' %}申请人{% else %}신청자{% endif %}</th>
                                    <th>{% if lang == 'en' %}Venue{% elif lang == 'ja' %}会場{% elif lang == 'zh' %}场馆{% else %}장소{% endif %}</th>
                                    <th>{% if lang == 'en' %}Date{% elif lang == 'ja' %}日付{% elif lang == 'zh' %}日期{% else %}날짜{% endif %}</th>
                                    <th>{% if lang == 'en' %}Contact{% elif lang == 'ja' %}連絡先{% elif lang == 'zh' %}联系方式{% else %}연락처{% endif %}</th>
                                    <th>{% if lang == 'en' %}Applied At{% elif lang == 'ja' %}申請日{% elif lang == 'zh' %}申请日期{% else %}신청일{% endif %}</th>
                                    <th>{% if lang == 'en' %}Actions{% elif lang == 'ja' %}操作{% elif lang == 'zh' %}操作{% else %}작업{% endif %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for performance in pending_performances %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="performance-checkbox" value="{{ performance.id }}">
                                    </td>
                                    <td>
                                        {% if performance.image_url %}
                                            <img src="{{ performance.image_url }}" alt="{{ performance.title }}" 
                                                 class="img-thumbnail zoomable-img" style="width: 60px; height: 60px; object-fit: cover; cursor: zoom-in;"
                                                 onclick="openImgZoom('{{ performance.image_url }}', event)">
                                        {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center" 
                                                 style="width: 60px; height: 60px;">
                                                <i class="fas fa-music text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ performance.title }}</strong>
                                        <br>
                                        <small class="text-muted">{{ performance.description[:50] }}...</small>
                                    </td>
                                    <td>{{ performance.group_name }}</td>
                                    <td>
                                        {% for user in users %}
                                            {% if user.id == performance.user_id %}
                                                <strong>{{ user.name }}</strong><br>
                                                <small class="text-muted">{{ user.username }}</small>
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>{{ performance.location }}</td>
                                    <td>{{ performance.date }} {{ performance.time }}</td>
                                    <td>{{ performance.contact_email }}</td>
                                    <td>{{ performance.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-info btn-sm" 
                                                    data-bs-toggle="modal" data-bs-target="#detailModal{{ performance.id }}">
                                                <i class="fas fa-eye me-1"></i>{% if lang == 'en' %}Detail{% elif lang == 'ja' %}詳細{% elif lang == 'zh' %}详情{% else %}상세{% endif %}
                                            </button>
                                            <form method="POST" action="/admin/approve/{{ performance.id }}" style="display: inline;">
                                                <button type="submit" class="btn btn-success btn-sm">
                                                    <i class="fas fa-check me-1"></i>{% if lang == 'en' %}Approve{% elif lang == 'ja' %}承認{% elif lang == 'zh' %}批准{% else %}승인{% endif %}
                                                </button>
                                            </form>
                                            <form method="POST" action="/admin/reject/{{ performance.id }}" style="display: inline;">
                                                <button type="submit" class="btn btn-danger btn-sm ms-1" 
                                                        onclick="return confirm('{% if lang == 'en' %}Are you sure you want to reject?{% elif lang == 'ja' %}本当に拒否しますか？{% elif lang == 'zh' %}确定要拒绝吗？{% else %}정말 거절하시겠습니까?{% endif %}')">
                                                    <i class="fas fa-times me-1"></i>{% if lang == 'en' %}Reject{% elif lang == 'ja' %}拒否{% elif lang == 'zh' %}拒绝{% else %}거절{% endif %}
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">
                            {% if lang == 'en' %}No pending performances{% elif lang == 'ja' %}承認待ちの公演はありません{% elif lang == 'zh' %}暂无待审批演出{% else %}승인 대기 중인 공연이 없습니다{% endif %}
                        </h5>
                        <p class="text-muted">
                            {% if lang == 'en' %}All applications have been processed.{% elif lang == 'ja' %}すべての申請が処理されました。{% elif lang == 'zh' %}所有申请已处理。{% else %}모든 신청이 처리되었습니다.{% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 승인된 공연 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>{% if lang == 'en' %}Approved Performances ({{ approved_performances|length }}){% elif lang == 'ja' %}承認済み ({{ approved_performances|length }}){% elif lang == 'zh' %}已批准 ({{ approved_performances|length }}){% else %}승인된 공연 ({{ approved_performances|length }}건){% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    {% if approved_performances %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% if lang == 'en' %}Image{% elif lang == 'ja' %}画像{% elif lang == 'zh' %}图片{% else %}이미지{% endif %}</th>
                                    <th>{% if lang == 'en' %}Title{% elif lang == 'ja' %}公演名{% elif lang == 'zh' %}演出名{% else %}공연명{% endif %}</th>
                                    <th>{% if lang == 'en' %}Team{% elif lang == 'ja' %}チーム名{% elif lang == 'zh' %}团队{% else %}팀명{% endif %}</th>
                                    <th>{% if lang == 'en' %}Venue{% elif lang == 'ja' %}会場{% elif lang == 'zh' %}场馆{% else %}장소{% endif %}</th>
                                    <th>{% if lang == 'en' %}Date{% elif lang == 'ja' %}日付{% elif lang == 'zh' %}日期{% else %}날짜{% endif %}</th>
                                    <th>{% if lang == 'en' %}Price{% elif lang == 'ja' %}価格{% elif lang == 'zh' %}票价{% else %}가격{% endif %}</th>
                                    <th>{% if lang == 'en' %}Approved At{% elif lang == 'ja' %}承認日{% elif lang == 'zh' %}批准日期{% else %}승인일{% endif %}</th>
                                    <th>{% if lang == 'en' %}View{% elif lang == 'ja' %}表示{% elif lang == 'zh' %}查看{% else %}보기{% endif %}</th>
                                    <th>{% if lang == 'en' %}Delete{% elif lang == 'ja' %}削除{% elif lang == 'zh' %}删除{% else %}삭제{% endif %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for performance in approved_performances %}
                                <tr>
                                    <td>
                                        {% if performance.image_url %}
                                            <img src="{{ performance.image_url }}" alt="{{ performance.title }}" 
                                                 class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center" 
                                                 style="width: 60px; height: 60px;">
                                                <i class="fas fa-music text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ performance.title }}</strong>
                                        <br>
                                        <small class="text-muted">{{ performance.description[:50] }}...</small>
                                    </td>
                                    <td>{{ performance.group_name }}</td>
                                    <td>{{ performance.location }}</td>
                                    <td>{{ performance.date }} {{ performance.time }}</td>
                                    <td><span class="badge bg-primary">{{ performance.price }}</span></td>
                                    <td>{{ performance.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <a href="/performance/{{ performance.id }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i>{% if lang == 'en' %}View{% elif lang == 'ja' %}表示{% elif lang == 'zh' %}查看{% else %}보기{% endif %}
                                        </a>
                                    </td>
                                    <td>
                                        <form method="POST" action="/admin/delete/{{ performance.id }}" style="display:inline;">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('{% if lang == 'en' %}Are you sure you want to delete?{% elif lang == 'ja' %}本当に削除しますか？{% elif lang == 'zh' %}确定要删除吗？{% else %}정말 삭제하시겠습니까?{% endif %}')">
                                                <i class="fas fa-trash me-1"></i>{% if lang == 'en' %}Delete{% elif lang == 'ja' %}削除{% elif lang == 'zh' %}删除{% else %}삭제{% endif %}
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-music fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">
                            {% if lang == 'en' %}No approved performances yet{% elif lang == 'ja' %}まだ承認済みの公演がありません{% elif lang == 'zh' %}暂无已批准演出{% else %}아직 승인된 공연이 없습니다{% endif %}
                        </h5>
                        <p class="text-muted">
                            {% if lang == 'en' %}Be the first to approve a performance!{% elif lang == 'ja' %}最初の公演を承認してください！{% elif lang == 'zh' %}快来批准第一个演出吧！{% else %}첫 번째 공연을 승인해보세요!{% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 통계 -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">
                        {% if lang == 'en' %}Pending{% elif lang == 'ja' %}審査中{% elif lang == 'zh' %}审核中{% else %}대기 중{% endif %}
                    </h5>
                    <h3 class="text-warning">{{ pending_performances|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h5 class="card-title">
                        {% if lang == 'en' %}Approved{% elif lang == 'ja' %}承認済み{% elif lang == 'zh' %}已批准{% else %}승인됨{% endif %}
                    </h5>
                    <h3 class="text-success">{{ approved_performances|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                    <h5 class="card-title">
                        {% if lang == 'en' %}Total Applications{% elif lang == 'ja' %}総申請数{% elif lang == 'zh' %}总申请数{% else %}총 신청{% endif %}
                    </h5>
                    <h3 class="text-primary">{{ pending_performances|length + approved_performances|length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 대시보드 차트 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>{% if lang == 'en' %}Performance Analytics{% elif lang == 'ja' %}公演分析{% elif lang == 'zh' %}演出分析{% else %}공연 분석{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-center mb-3">{% if lang == 'en' %}Monthly Performance Registration{% elif lang == 'ja' %}月別公演登録{% elif lang == 'zh' %}月度演出注册{% else %}월별 공연 등록{% endif %}</h5>
                            <canvas id="monthlyChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-center mb-3">{% if lang == 'en' %}Performance by Category{% elif lang == 'ja' %}カテゴリー別公演{% elif lang == 'zh' %}类别演出{% else %}카테고리별 공연{% endif %}</h5>
                            <canvas id="categoryChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 데이터 내보내기 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-download me-2"></i>{% if lang == 'en' %}Export Data{% elif lang == 'ja' %}データエクスポート{% elif lang == 'zh' %}数据导出{% else %}데이터 내보내기{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{% if lang == 'en' %}Export All Performances{% elif lang == 'ja' %}全公演エクスポート{% elif lang == 'zh' %}导出所有演出{% else %}전체 공연 내보내기{% endif %}</h6>
                            <a href="/admin/export/excel" class="btn btn-success me-2">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </a>
                            <a href="/admin/export/csv" class="btn btn-info">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </a>
                        </div>
                        <div class="col-md-6">
                            <h6>{% if lang == 'en' %}Export Filtered Data{% elif lang == 'ja' %}フィルター済みデータエクスポート{% elif lang == 'zh' %}导出筛选数据{% else %}필터링된 데이터 내보내기{% endif %}</h6>
                            <a href="/admin/export/excel?{{ request.query_string.decode() }}" class="btn btn-success me-2">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </a>
                            <a href="/admin/export/csv?{{ request.query_string.decode() }}" class="btn btn-info">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.img-zoom-modal {
  display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.8); justify-content: center; align-items: center;
}
.img-zoom-modal.active { display: flex; }
.img-zoom-modal img { max-width: 90vw; max-height: 90vh; border-radius: 10px; box-shadow: 0 0 20px #000; }
.img-zoom-modal .close-btn { position: absolute; top: 40px; right: 60px; font-size: 2.5rem; color: #fff; cursor: pointer; }
</style>

<div id="imgZoomModal" class="img-zoom-modal" onclick="closeImgZoom()">
  <span class="close-btn" onclick="closeImgZoom(event)">&times;</span>
  <img id="imgZoomTarget" src="" alt="확대 이미지">
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function openImgZoom(src, event) {
  event.stopPropagation();
  document.getElementById('imgZoomTarget').src = src;
  document.getElementById('imgZoomModal').classList.add('active');
}
function closeImgZoom(e) {
  if (e) e.stopPropagation();
  document.getElementById('imgZoomModal').classList.remove('active');
  document.getElementById('imgZoomTarget').src = '';
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeImgZoom();
});

// 일괄 관리 기능
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.performance-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function getSelectedPerformances() {
    const checkboxes = document.querySelectorAll('.performance-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function bulkApprove() {
    const selectedIds = getSelectedPerformances();
    if (selectedIds.length === 0) {
        alert('선택된 공연이 없습니다.');
        return;
    }
    if (confirm(`${selectedIds.length}개의 공연을 승인하시겠습니까?`)) {
        fetch('/admin/bulk-approve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({performance_ids: selectedIds})
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('오류가 발생했습니다: ' + data.error);
            }
        });
    }
}

function bulkReject() {
    const selectedIds = getSelectedPerformances();
    if (selectedIds.length === 0) {
        alert('선택된 공연이 없습니다.');
        return;
    }
    if (confirm(`${selectedIds.length}개의 공연을 거절하시겠습니까?`)) {
        fetch('/admin/bulk-reject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({performance_ids: selectedIds})
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('오류가 발생했습니다: ' + data.error);
            }
        });
    }
}

// 차트 데이터
const monthlyData = {{ monthly_chart_data | tojson }};
const categoryData = {{ category_chart_data | tojson }};

// 월별 차트
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: monthlyData.labels,
        datasets: [{
            label: '공연 등록 수',
            data: monthlyData.data,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// 카테고리별 차트
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: categoryData.labels,
        datasets: [{
            data: categoryData.data,
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40',
                '#FF6384',
                '#C9CBCF',
                '#4BC0C0'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

<!-- 공연 상세 정보 모달들 -->
{% for performance in pending_performances %}
<div class="modal fade" id="detailModal{{ performance.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>{{ performance.title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        {% if performance.image_url %}
                            <img src="{{ performance.image_url }}" alt="{{ performance.title }}" 
                                 class="img-fluid rounded mb-3 zoomable-img" style="max-height: 200px; object-fit: cover; cursor: zoom-in;"
                                 onclick="openImgZoom('{{ performance.image_url }}', event)">
                        {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center rounded mb-3" 
                                 style="height: 200px;">
                                <i class="fas fa-music fa-3x text-muted"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <h6><i class="fas fa-users me-2"></i>{% if lang == 'en' %}Team/Crew Name{% elif lang == 'ja' %}チーム名/クルー名{% elif lang == 'zh' %}团队/团队名{% else %}팀명/크루명{% endif %}</h6>
                        <p>{{ performance.group_name }}</p>
                        
                        <h6><i class="fas fa-align-left me-2"></i>{% if lang == 'en' %}Performance Introduction{% elif lang == 'ja' %}公演紹介{% elif lang == 'zh' %}演出介绍{% else %}공연 소개{% endif %}</h6>
                        <p>{{ performance.description|nl2br|safe }}</p>
                        
                        <h6><i class="fas fa-map-marker-alt me-2"></i>{% if lang == 'en' %}Performance Venue{% elif lang == 'ja' %}公演会場{% elif lang == 'zh' %}演出场馆{% else %}공연 장소{% endif %}</h6>
                        <p>{{ performance.location }}</p>
                        
                        <h6><i class="fas fa-calendar me-2"></i>{% if lang == 'en' %}Performance Date and Time{% elif lang == 'ja' %}公演日時{% elif lang == 'zh' %}演出日期和时间{% else %}공연 일시{% endif %}</h6>
                        <p>{{ performance.date }} {{ performance.time }}</p>
                        
                        <h6><i class="fas fa-ticket-alt me-2"></i>{% if lang == 'en' %}Ticket Price{% elif lang == 'ja' %}チケット価格{% elif lang == 'zh' %}票价{% else %}티켓 가격{% endif %}</h6>
                        <p>{{ performance.price }}</p>
                        
                        <h6><i class="fas fa-envelope me-2"></i>{% if lang == 'en' %}Contact{% elif lang == 'ja' %}連絡先{% elif lang == 'zh' %}联系方式{% else %}연락처{% endif %}</h6>
                        <p>{{ performance.contact_email }}</p>
                        
                        {% if performance.video_url %}
                        <h6><i class="fas fa-video me-2"></i>{% if lang == 'en' %}Promotional Video{% elif lang == 'ja' %}宣伝動画{% elif lang == 'zh' %}宣传视频{% else %}홍보 동영상{% endif %}</h6>
                        <p><a href="{{ performance.video_url }}" target="_blank">{{ performance.video_url }}</a></p>
                        {% endif %}
                        
                        <h6><i class="fas fa-user me-2"></i>{% if lang == 'en' %}Applicant Information{% elif lang == 'ja' %}申請者情報{% elif lang == 'zh' %}申请人信息{% else %}신청자 정보{% endif %}</h6>
                        {% for user in users %}
                            {% if user.id == performance.user_id %}
                                <p><strong>{{ user.name }}</strong> ({{ user.username }})<br>
                                <small class="text-muted">{{ user.email }} | {{ user.phone }}</small></p>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <form method="POST" action="/admin/approve/{{ performance.id }}" style="display: inline;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>{% if lang == 'en' %}Approve{% elif lang == 'ja' %}承認{% elif lang == 'zh' %}批准{% else %}승인{% endif %}
                    </button>
                </form>
                <form method="POST" action="/admin/reject/{{ performance.id }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('{% if lang == 'en' %}Are you sure you want to reject?{% elif lang == 'ja' %}本当に拒否しますか？{% elif lang == 'zh' %}确定要拒绝吗？{% else %}정말 거절하시겠습니까?{% endif %}')">
                        <i class="fas fa-times me-1"></i>{% if lang == 'en' %}Reject{% elif lang == 'ja' %}拒否{% elif lang == 'zh' %}拒绝{% else %}거절{% endif %}
                    </button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% if lang == 'en' %}Close{% elif lang == 'ja' %}閉じる{% elif lang == 'zh' %}关闭{% else %}닫기{% endif %}</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %} 